# ========================================
# é€ åƒé¦†æœåŠ¡å™¨éƒ¨ç½² - å®Œæ•´å‘½ä»¤
# ========================================
# è¯·åœ¨è…¾è®¯äº‘æœåŠ¡å™¨æ§åˆ¶å°ä¸­å¤åˆ¶ä»¥ä¸‹å‘½ä»¤å¹¶æ‰§è¡Œ
# ========================================

# 1. åˆ›å»ºç›®å½•å¹¶è¿›å…¥
mkdir -p /root/zhaoxiangguan && cd /root/zhaoxiangguan

# 2. åˆ›å»º package.json
cat > package.json << 'EOF'
{
  "name": "zhaoxiangguan-api",
  "version": "1.0.0",
  "description": "é€ åƒé¦†APIæœåŠ¡",
  "main": "server.js",
  "scripts": {
    "start": "node server.js"
  },
  "dependencies": {
    "express": "^4.18.2",
    "cors": "^2.8.5",
    "body-parser": "^1.20.2",
    "node-fetch": "^2.7.0"
  }
}
EOF

# 3. åˆ›å»ºæœåŠ¡å™¨æ–‡ä»¶ (server.js)
# æ³¨æ„ï¼šç”±äºæ–‡ä»¶è¾ƒå¤§ï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼  server-free-huggingface.js å¹¶é‡å‘½åä¸º server.js
# æˆ–è€…æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤åˆ›å»ºç®€åŒ–ç‰ˆæœ¬

cat > server.js << 'SERVERCODE'
const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const fetch = require('node-fetch');
const fs = require('fs');
const path = require('path');

const app = express();
const PORT = 3001;

app.use(cors());
app.use(bodyParser.json({ limit: '50mb' }));
app.use(express.static('uploads'));

const uploadsDir = path.join(__dirname, 'uploads');
if (!fs.existsSync(uploadsDir)) fs.mkdirSync(uploadsDir, { recursive: true });

const HF_API_URL = 'https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0';

app.get('/api/health', (req, res) => {
  res.json({ success: true, message: 'Server is running', model: 'Stable Diffusion XL' });
});

app.post('/api/login', (req, res) => {
  const { phone } = req.body;
  res.json({
    success: true,
    message: 'ç™»å½•æˆåŠŸ',
    data: { userId: `user_${phone}`, phone: phone, points: 999999 }
  });
});

app.post('/api/generate', async (req, res) => {
  try {
    const { style, substyle, userId } = req.body;
    const prompts = {
      'å†™çœŸ': { 'æ—¥ç³»æ¸…æ–°': 'portrait, soft natural lighting, japanese style' },
      'è‰ºæœ¯': { 'æ—¶å°šæ‚å¿—': 'portrait, magazine cover style' },
      'å¤é£': { 'æ±‰æœ': 'portrait, traditional chinese hanfu' },
      'å¤å¤': { 'æ¸¯é£': 'portrait, 1980s hong kong style' },
      'å©šçº±': { 'å®¤å†…ä¸»çº±': 'portrait, wedding photography' },
      'è¯ä»¶': { 'ä¸€å¯¸': 'portrait, id photo' }
    };
    const prompt = (prompts[style] && prompts[style][substyle]) || 'portrait, beautiful';

    const hfResponse = await fetch(HF_API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        inputs: prompt,
        parameters: { num_inference_steps: 25, width: 512, height: 768 }
      })
    });

    if (!hfResponse.ok) throw new Error(`APIé”™è¯¯: ${hfResponse.status}`);

    const buffer = await hfResponse.buffer();
    const filename = `${userId}_${Date.now()}.png`;
    fs.writeFileSync(path.join(uploadsDir, filename), buffer);

    res.json({
      success: true,
      imageUrl: `http://121.5.33.130:3001/uploads/${filename}`,
      filename: filename
    });
  } catch (error) {
    console.error('ç”Ÿæˆå¤±è´¥:', error);
    res.status(500).json({ success: false, message: error.message });
  }
});

app.listen(PORT, () => {
  console.log(`æœåŠ¡å™¨è¿è¡Œåœ¨ http://localhost:${PORT}`);
  console.log(`å¤–ç½‘è®¿é—®: http://121.5.33.130:${PORT}`);
});
SERVERCODE

# 4. å®‰è£…ä¾èµ–
npm install

# 5. å®‰è£…PM2 (å¦‚æœæœªå®‰è£…)
npm install -g pm2

# 6. å¯åŠ¨æœåŠ¡
pm2 delete zhaoxiangguan 2>/dev/null
pm2 start server.js --name zhaoxiangguan
pm2 save

# 7. æ˜¾ç¤ºçŠ¶æ€
pm2 status
pm2 logs zhaoxiangguan --lines 20

echo "=========================================="
echo "âœ… éƒ¨ç½²å®Œæˆ!"
echo "ğŸŒ http://121.5.33.130:3001"
echo "=========================================="
